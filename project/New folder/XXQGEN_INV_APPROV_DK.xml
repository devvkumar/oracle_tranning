<?xml version="1.0" encoding="UTF-8"?>
<DATATEMPLATE NAME="XXQGEN_INV_APROV_DK" VERSION="1.0">
    <PROPERTIES>
        <PROPERTY NAME="XML_TAG_CASE" VALUE="UPPER"/>
    </PROPERTIES>
    <PARAMETERS>
        <PARAMETER NAME="P_TRADING_PARTNER" DATATYPE="NUMBER"/>
        <PARAMETER NAME="P_CURRENCY_CODE" DATATYPE="CHARACTER"/>
        <PARAMETER NAME="P_START_CREATION_DATE" DATATYPE="DATE"/>
        <PARAMETER NAME="P_END_CREATION_DATE" DATATYPE="DATE"/>
    </PARAMETERS>
    <DATAQUERY>
        <SQLSTATEMENT NAME="Q_MAIN">
            <![CDATA[
SELECT INV1.VENDOR_ID C_VENDOR_ID,
       HP.PARTY_NAME TRADING_PARTNER,
       TO_CHAR(INV1.INVOICE_DATE, 'DD-MON-RRRR HH24:MI') INVOICE_DATE,
       B.BATCH_NAME BATCH_NAME,
       INV1.INVOICE_ID C_INVOICE_ID,
       INV1.INVOICE_NUM INVOICE_NUM,
       (SELECT DISTINCT POH.SEGMENT1 C_PO_NUMBER
          FROM PO_HEADERS POH,
               PO_DISTRIBUTIONS_ALL PDA,
               AP_INVOICE_DISTRIBUTIONS_ALL AIDA
         WHERE POH.PO_HEADER_ID = PDA.PO_HEADER_ID
           AND PDA.PO_DISTRIBUTION_ID = AIDA.PO_DISTRIBUTION_ID
           AND AIDA.INVOICE_ID = INV1.INVOICE_ID) PO_NUMBER,
       DECODE(INV1.INVOICE_CURRENCY_CODE,
              'USD', INV1.INVOICE_AMOUNT,
              INV1.BASE_AMOUNT) ORIGINAL_AMOUNT,
       DECODE(INV1.INVOICE_CURRENCY_CODE,
              'USD', INV1.INVOICE_AMOUNT,
              INV1.BASE_AMOUNT)
       - DECODE(INV1.PAYMENT_CURRENCY_CODE,
                'USD', NVL(INV1.AMOUNT_PAID, 0) + NVL(DISCOUNT_AMOUNT_TAKEN, 0),
                ROUND((DECODE(INV1.PAYMENT_CROSS_RATE_TYPE,
                              'EMU FIXED', 1 / INV1.PAYMENT_CROSS_RATE,
                              INV1.EXCHANGE_RATE) * NVL(INV1.AMOUNT_PAID, 0)), F.PRECISION)
                + ROUND((DECODE(INV1.PAYMENT_CROSS_RATE_TYPE,
                                'EMU FIXED', 1 / INV1.PAYMENT_CROSS_RATE,
                                INV1.EXCHANGE_RATE) * NVL(INV1.DISCOUNT_AMOUNT_TAKEN, 0)), F.PRECISION)
               ) AMOUNT_REMAINING,
       INV1.DESCRIPTION C_DESCRIPTION,
       APPS.AP_INVOICES_PKG.GET_APPROVAL_STATUS(INV1.INVOICE_ID, INV1.INVOICE_AMOUNT,
                                                INV1.PAYMENT_STATUS_FLAG, INV1.INVOICE_TYPE_LOOKUP_CODE) APPROVAL_STATUS,
       AIAHA.LAST_UPDATE_DATE DUE_DATE, 
       APT.NAME PAYMENT_TERM,
       AIAHA.RESPONSE NOTES, 
       AIAHA.APPROVER_NAME,
       INV1.CREATION_DATE
  FROM HZ_PARTIES HP,
       AP_INVOICES_ALL INV1,
       AP_BATCHES_ALL B,
       AP_PAYMENT_SCHEDULES_ALL S,
       AP_TERMS APT,
       AP_INV_APRVL_HIST_ALL AIAHA,
       FND_CURRENCIES_VL F
 WHERE HP.PARTY_ID = INV1.PARTY_ID
   AND B.BATCH_ID(+) = INV1.BATCH_ID
   AND S.INVOICE_ID(+) = INV1.INVOICE_ID
   AND APT.TERM_ID = INV1.TERMS_ID
   AND AIAHA.INVOICE_ID(+) = INV1.INVOICE_ID
   AND F.CURRENCY_CODE = INV1.INVOICE_CURRENCY_CODE
   AND (HP.PARTY_ID = :P_TRADING_PARTNER OR :P_TRADING_PARTNER IS NULL)
   AND (F.CURRENCY_CODE = :P_CURRENCY_CODE OR F.CURRENCY_CODE = 'USD')
   AND TO_CHAR(INV1.CREATION_DATE, 'DD-MM-RRRR') >= NVL(TO_CHAR(:P_START_CREATION_DATE, 'DD-MM-RRRR'), TO_CHAR(INV1.CREATION_DATE, 'DD-MM-RRRR'))
   AND TO_CHAR(INV1.CREATION_DATE, 'DD-MM-RRRR') <= NVL(TO_CHAR(:P_END_CREATION_DATE, 'DD-MM-RRRR'), TO_CHAR(INV1.CREATION_DATE, 'DD-MM-RRRR'))
            ]]>
        </SQLSTATEMENT>
    </DATAQUERY>
    <DATASTRUCTURE>
        <GROUP NAME="G_MAIN" DATATYPE="VARCHAR2" SOURCE="Q_MAIN">
            <ELEMENT NAME="BATCH_NAME" DATATYPE="VARCHAR2" VALUE="BATCH_NAME"/>
            <ELEMENT NAME="TRADING_PARTNER" DATATYPE="VARCHAR2" VALUE="TRADING_PARTNER"/>
            <ELEMENT NAME="INVOICE_NUM" DATATYPE="VARCHAR2" VALUE="INVOICE_NUM"/>
            <ELEMENT NAME="PO_NUMBER" DATATYPE="VARCHAR2" VALUE="PO_NUMBER"/>
            <ELEMENT NAME="INV_DATE" DATATYPE="DATE" VALUE="INVOICE_DATE"/>
            <ELEMENT NAME="ORG_AMOUNT" DATATYPE="NUMBER" VALUE="ORIGINAL_AMOUNT"/>
            <ELEMENT NAME="AMOUNT_REMAIN" DATATYPE="NUMBER" VALUE="AMOUNT_REMAINING"/>
            <ELEMENT NAME="APPROVAL_STATUS" DATATYPE="VARCHAR2" VALUE="APPROVAL_STATUS"/>
            <ELEMENT NAME="APPROVER_NAME" DATATYPE="VARCHAR2" VALUE="APPROVER_NAME"/>
            <ELEMENT NAME="DUE_DATE" DATATYPE="DATE" VALUE="DUE_DATE"/>
            <ELEMENT NAME="PAYMENT_TERM" DATATYPE="VARCHAR2" VALUE="PAYMENT_TERM"/>
            <ELEMENT NAME="NOTES" DATATYPE="VARCHAR2" VALUE="NOTES"/>
        </GROUP>
    </DATASTRUCTURE>
</DATATEMPLATE>
